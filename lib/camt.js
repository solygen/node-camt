/* node-camt.0.0.1 (2014-05-03) https://github.com/solygen/node-camt.git */!function(){"use strict";function a(a,b){var e=[],f={comment:"#",delimiter:";",escape:'"'};d().from.path(a,f).transform(function(a){return a.map(function(a){return a.trim().replace(/\s+/g," ")})}).on("record",function(a){e.push(a)}).on("end",function(){console.log(a,":",e.length),b.call(this,{columns:e.shift(),rows:e,account:c.basename(a).split("-")[1]})}).on("error",function(a){console.log(a.message)})}var b=require("fs"),c=require("path"),d=require("csv"),e=require("lodash"),f=(process.argv.slice(2),__dirname.replace("/src","/data/")),g={},h=function(a){var d=c.sep,e="",f=a.split(d);f.forEach(function(a){e=e+d+a,b.existsSync(e)||b.mkdirSync(e)})},i=function(a){var d={},i=a.rows,j=a.account;g.columns=a.columns,g.accounts=g.accounts||{},g.accounts[j]=[],i.forEach(function(a){var b=a[2],c=b.match(/(\d+)/g),e=c[2],f=e+"-"+c[1];d[e]=d[e]||[],d[e][f]=d[e][f]||[],d[e][f].push(a)}),Object.keys(d).forEach(function(a){var i,k=[];Object.keys(d[a]).forEach(function(g){var i,l=c.join(f,j,a);if(h(l),i=l+g+".json",b.existsSync(i)){var m=b.readFileSync(i,"utf8"),n=JSON.parse(m);d[a][g]=(d[a][g]||[]).concat(n)}d[a][g]=e.uniq(d[a][g],function(a){return JSON.stringify(a)}),d[a][g].sort(function(a,b){var c=a[1].match(/(\d+)/g),d=b[1].match(/(\d+)/g);return parseInt(c[2]+c[1]+c[0],10)-parseInt(d[2]+d[1]+d[0],10)}),k=k.concat(d[a][g]),b.writeFileSync(l+g+".json",JSON.stringify(d[a][g],void 0,2))}),i=c.join(f+j)+c.sep+(a+".json"),g.accounts[j]=g.accounts[j].concat(i),b.writeFileSync(i,JSON.stringify(k,void 0,2))}),b.writeFileSync(f+"data.json",JSON.stringify(g,void 0,2))},j=b.readdirSync(f+"/source");j.forEach(function(b){"csv"===b.split(".")[1]&&a(f+"/source/"+b,i)})}();